<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 í•œêµ­ ì½”ë¦¬ì•„ì»µ ì˜¤í”ˆ - k.f.c. ì‹œë¦¬ìš°ìŠ¤</title>
    <style>
        :root {
            --primary-color: #e0e7ff;
            --accent-color: #6366f1;
            --bg-dark: #020617;
            --text-main: #f8fafc;
            --transition-speed: 0.8s;
            --game-accent: #00f2ff;
            --danger-color: #f43f5e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            touch-action: none;
        }

        #bg-canvas {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
        }

        #progress-container {
            position: fixed;
            top: 0; left: 0; width: 100%; padding: 20px;
            z-index: 100;
            display: flex; flex-direction: column; align-items: center;
        }

        .gauge-wrapper {
            width: 80%; max-width: 600px; height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px; overflow: hidden; margin-bottom: 10px;
        }

        #gauge-bar {
            height: 100%; width: 25%;
            background: linear-gradient(90deg, var(--accent-color), #a5b4fc);
            transition: width 0.5s ease;
            box-shadow: 0 0 15px var(--accent-color);
        }

        #current-page-title {
            font-size: 0.8rem; color: var(--primary-color);
            text-transform: uppercase; letter-spacing: 2px;
        }

        .app-container {
            height: 100vh; display: flex;
            justify-content: center; align-items: center; padding: 20px;
        }

        .page {
            position: absolute; width: 100%; max-width: 850px;
            text-align: center; opacity: 0; visibility: hidden;
            transform: translateY(30px);
            transition: opacity var(--transition-speed), transform var(--transition-speed), visibility var(--transition-speed);
            padding: 30px; background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(20px); border-radius: 32px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 90vh; display: flex; flex-direction: column;
        }

        .page.active { opacity: 1; visibility: visible; transform: translateY(0); }

        h1 { font-size: 2.5rem; margin-bottom: 0.5rem; color: #fff; text-shadow: 0 0 20px rgba(99, 102, 241, 0.5); }
        h2 { font-size: 1.3rem; color: var(--accent-color); margin-bottom: 1.5rem; letter-spacing: 1px; }
        p { line-height: 1.6; color: #cbd5e1; }

        .team-info {
            margin: 1rem 0; padding: 1rem 2rem; border-left: 3px solid var(--accent-color);
            text-align: left; display: inline-block; background: rgba(255, 255, 255, 0.03);
            border-radius: 0 12px 12px 0;
        }
        .label { color: var(--accent-color); font-weight: bold; margin-right: 12px; }

        #game-wrapper { width: 100%; max-width: 700px; margin: 15px auto; position: relative; }
        #game-container {
            width: 100%; height: 300px; background: rgba(0, 0, 0, 0.6);
            border: 2px solid var(--accent-color); border-radius: 16px;
            position: relative; overflow: hidden; cursor: pointer;
        }
        #game-canvas { display: block; }
        .game-meta {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 10px; font-weight: 500; color: var(--accent-color); font-size: 0.9rem;
        }
        .badge {
            padding: 4px 12px; border-radius: 20px; font-size: 0.7rem;
            font-weight: bold; border: 1px solid currentColor; background: rgba(255,255,255,0.05);
        }

        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .detail-item {
            background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 16px;
            text-align: left; border-bottom: 2px solid transparent; transition: 0.3s;
        }
        .detail-item:hover { border-bottom: 2px solid var(--accent-color); background: rgba(255, 255, 255, 0.08); }

        #guestbook-list {
            margin: 20px 0; flex-grow: 1; overflow-y: auto;
            display: flex; flex-direction: column; gap: 10px; padding: 10px;
            background: rgba(0, 0, 0, 0.3); border-radius: 16px; text-align: left;
        }
        .guest-item {
            background: rgba(255, 255, 255, 0.07); padding: 12px 15px; border-radius: 12px;
            border-left: 3px solid var(--accent-color); font-size: 0.9rem; animation: fadeIn 0.4s ease;
        }
        #guestbook-list::-webkit-scrollbar { width: 4px; }
        #guestbook-list::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 10px; }

        .closing-quote {
            font-size: 3rem; font-weight: 900; margin: 1rem 0;
            background: linear-gradient(135deg, #fff, var(--accent-color));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: glow 2s infinite alternate;
        }
        @keyframes glow {
            from { filter: drop-shadow(0 0 10px rgba(255,255,255,0.2)); }
            to { filter: drop-shadow(0 0 25px var(--accent-color)); }
        }

        .btn {
            background: var(--accent-color); color: white; border: none;
            padding: 12px 30px; border-radius: 50px; font-size: 0.95rem;
            cursor: pointer; transition: 0.3s; font-weight: 700;
        }
        .btn:hover { transform: translateY(-3px); background: #4f46e5; }

        .skip-btn {
            background: rgba(255, 255, 255, 0.1); color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.2); padding: 6px 14px;
            border-radius: 8px; font-size: 0.75rem; cursor: pointer;
        }

        #guest-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none;
            justify-content: center; align-items: center; z-index: 500;
        }
        .modal-inner {
            background: #0f172a; padding: 30px; border-radius: 24px;
            width: 90%; max-width: 400px; border: 1px solid var(--accent-color);
        }
        textarea {
            width: 100%; height: 100px; background: #1e293b; border: 1px solid #334155;
            border-radius: 12px; color: white; padding: 15px; margin: 15px 0; resize: none;
        }

        #sound-toggle {
            position: absolute; top: 10px; left: 10px;
            background: rgba(255,255,255,0.1); border: none; color: white;
            border-radius: 50%; width: 30px; height: 30px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 0.8rem;
        }

        @media (max-width: 600px) {
            h1 { font-size: 1.8rem; }
            .closing-quote { font-size: 2.2rem; }
            #game-container { height: 200px; }
        }
    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>

    <div id="progress-container">
        <div class="gauge-wrapper">
            <div id="gauge-bar"></div>
        </div>
        <div id="current-page-title">Main Page</div>
    </div>

    <div class="app-container">
        <section id="page-1" class="page active">
            <h2>2026 í•œêµ­ ì½”ë¦¬ì•„ì»µ ì˜¤í”ˆ</h2>
            <h1>k.f.c. ì‹œë¦¬ìš°ìŠ¤</h1>
            <div class="team-info">
                <div><span class="label">TEAM</span> k.f.c. ì‹œë¦¬ìš°ìŠ¤</div>
                <div><span class="label">MEMBERS</span> ìœ¤ìš°, ì§€í˜¸, ë„í˜„</div>
            </div>
            <p>ì†Œë¦¬ê°€ ë”í•´ì§„ ìµœê³ ì˜ ê²½í—˜. ì‹œë¦¬ìš°ìŠ¤ íŒ€ì˜ ë„ì „ì„ í™•ì¸í•˜ì„¸ìš”.</p>
            <div style="margin-top: 20px;">
                <button class="btn" onclick="nextPage(2)">í”„ë¡œì íŠ¸ ì‹œì‘</button>
            </div>
        </section>

        <section id="page-2" class="page">
            <h2>ëŒ€íšŒ íšŒê³  (Retrospective)</h2>
            <div class="details-grid">
                <div class="detail-item">
                    <p style="color:var(--accent-color); font-weight:bold; margin-bottom:5px;">ê°€ì¥ ì•„ì‰¬ìš´ ì </p>
                    <p>ìš°ë¦¬ íŒ€ í”„ë¡œê·¸ë¨ì„ ì“°ì§€ ì•Šê³  ì´ê²¼ë‹¤</p>
                </div>
                <div class="detail-item">
                    <p style="color:var(--accent-color); font-weight:bold; margin-bottom:5px;">ê°œì„ í•´ì•¼ í•  ì </p>
                    <p>ìš°ë¦¬ê°€ ì˜í•´ì„œ ìš°ë¦¬ í”„ë¡œê·¸ë¨ìœ¼ë¡œ ì´ê¸°ê³  ì‹¶ë‹¤</p>
                </div>
                <div class="detail-item">
                    <p style="color:var(--accent-color); font-weight:bold; margin-bottom:5px;">ìš°ë¦¬ íŒ€ì´ ì˜í•œ ì </p>
                    <p>ì˜ëª»ëœ ì ì´ ë‚˜ì˜¤ë©´ ë°”ë¡œ ê³ ì³¤ë‹¤</p>
                </div>
                <div class="detail-item">
                    <p style="color:var(--accent-color); font-weight:bold; margin-bottom:5px;">ëŒ€íšŒë¥¼ í†µí•´ ë°°ìš´ ì </p>
                    <p>ë…¸ë ¥í•˜ë©´ ë­ë“ ì§€ ëœë‹¤</p>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn" onclick="nextPage(3)">ë…¸ë ¥ì˜ ì‹œë ¨ (Game)</button>
            </div>
        </section>

        <section id="page-3" class="page">
            <h2 id="map-name-display">ë…¸ë ¥ì˜ ë¹„í–‰</h2>
            <div id="game-wrapper">
                <div id="game-container">
                    <canvas id="game-canvas"></canvas>
                    <button id="sound-toggle" onclick="toggleMute(event)">ğŸ”Š</button>
                    <div id="mode-badge" style="position:absolute; top:10px; right:10px;" class="badge">CUBE</div>
                </div>
                <div class="game-meta">
                    <span id="game-status">ì§„í–‰ë„: 0%</span>
                    <button class="skip-btn" onclick="skipGame()">ì‹œë ¨ ê±´ë„ˆë›°ê¸° â©</button>
                    <span id="game-best">ìµœê³  ê¸°ë¡: 0%</span>
                </div>
            </div>
            <p class="game-hint" style="font-size:0.8rem; color:#94a3b8;">ì¡°ì‘: í´ë¦­ / í„°ì¹˜ / ìŠ¤í˜ì´ìŠ¤ë°”</p>
        </section>

        <section id="page-4" class="page">
            <h2>ëŒ€íšŒ ë§ˆë¬´ë¦¬</h2>
            <div class="closing-quote">"ë…¸ë ¥í•˜ì"</div>
            <p style="margin-bottom: 15px;">ë°©ëª…ë¡ì— ë”°ëœ»í•œ ì‘ì›ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.</p>
            <div id="guestbook-list">
                <div class="guest-item">ì‘ì„±ëœ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
            </div>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn" onclick="showGuestModal()">ë°©ëª…ë¡ ì‘ì„±</button>
            </div>
        </section>
    </div>

    <div id="guest-modal">
        <div class="modal-inner">
            <h3>ë°©ëª…ë¡ ë‚¨ê¸°ê¸°</h3>
            <textarea id="guest-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="flex:1" onclick="addGuestbook()">ë³´ë‚´ê¸°</button>
                <button class="btn" style="flex:1; background:#334155;" onclick="hideGuestModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // --- Sound Engine (Web Audio API) ---
        let audioCtx = null;
        let isMuted = false;
        let bgmOsc = null;
        let bgmGain = null;

        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playJumpSound() {
            if (!audioCtx || isMuted) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(200, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        function playCrashSound() {
            if (!audioCtx || isMuted) return;
            const bufferSize = audioCtx.sampleRate * 0.2;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(400, audioCtx.currentTime);
            noise.connect(filter); filter.connect(audioCtx.destination);
            noise.start();
        }

        function playWinSound() {
            if (!audioCtx || isMuted) return;
            const notes = [523.25, 659.25, 783.99, 1046.50];
            notes.forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime + i * 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime + i * 0.1);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i * 0.1 + 0.3);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(audioCtx.currentTime + i * 0.1); osc.stop(audioCtx.currentTime + i * 0.1 + 0.3);
            });
        }

        function toggleBGM(on) {
            if (!audioCtx) return;
            if (on && !isMuted) {
                if (bgmOsc) return;
                bgmGain = audioCtx.createGain();
                bgmGain.gain.setValueAtTime(0.02, audioCtx.currentTime);
                bgmGain.connect(audioCtx.destination);
                
                const playStep = (time, freq) => {
                    const osc = audioCtx.createOscillator();
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(freq, time);
                    const g = audioCtx.createGain();
                    g.gain.setValueAtTime(0.02, time);
                    g.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
                    osc.connect(g); g.connect(audioCtx.destination);
                    osc.start(time); osc.stop(time + 0.1);
                }
                
                let beat = 0;
                bgmInterval = setInterval(() => {
                    if (isMuted || !gameActive) return;
                    const now = audioCtx.currentTime;
                    const scale = [130.81, 146.83, 164.81, 196.00];
                    playStep(now, scale[beat % 4]);
                    if (beat % 4 === 0) playStep(now, 65.41); // Kick
                    beat++;
                }, 200);
            } else {
                if (typeof bgmInterval !== 'undefined') clearInterval(bgmInterval);
            }
        }

        function toggleMute(e) {
            e.stopPropagation();
            isMuted = !isMuted;
            document.getElementById('sound-toggle').innerText = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
        }

        // --- Background Animation ---
        const bgCanvas = document.getElementById('bg-canvas');
        const bgCtx = bgCanvas.getContext('2d');
        let stars = [], fireworks = [], shootingStars = [];

        function initBG() {
            bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight;
            stars = Array.from({length: 150}, () => ({
                x: Math.random() * bgCanvas.width, y: Math.random() * bgCanvas.height,
                size: Math.random() * 2, opacity: Math.random(), speed: 0.005 + Math.random() * 0.015
            }));
        }

        function drawBG() {
            bgCtx.fillStyle = '#020617'; bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);
            stars.forEach(s => {
                bgCtx.beginPath(); bgCtx.arc(s.x, s.y, s.size, 0, Math.PI*2);
                bgCtx.fillStyle = `rgba(224, 231, 255, ${Math.abs(Math.sin(s.opacity))})`; bgCtx.fill();
                s.opacity += s.speed;
            });
            if (Math.random() < 0.01) {
                shootingStars.push({
                    x: Math.random() * bgCanvas.width, y: -20, vx: 5 + Math.random()*5, vy: 5 + Math.random()*5,
                    life: 1.0, length: 60 + Math.random()*100
                });
            }
            shootingStars.forEach((ss, i) => {
                ss.x += ss.vx; ss.y += ss.vy; ss.life -= 0.015;
                if (ss.life <= 0) shootingStars.splice(i,1);
                else {
                    bgCtx.strokeStyle = `rgba(255,255,255,${ss.life})`; bgCtx.lineWidth = 2;
                    bgCtx.beginPath(); bgCtx.moveTo(ss.x, ss.y); bgCtx.lineTo(ss.x - ss.vx*10, ss.y - ss.vy*10); bgCtx.stroke();
                }
            });
            fireworks.forEach((fw, i) => { fw.update(); fw.draw(); if (fw.life <= 0) fireworks.splice(i,1); });
            requestAnimationFrame(drawBG);
        }

        class FireworkPart {
            constructor(x, y) {
                this.x = x; this.y = y; this.life = 1.0;
                this.color = `hsl(${Math.random()*360}, 100%, 60%)`;
                this.parts = Array.from({length: 40}, () => ({
                    vx: (Math.random()-0.5)*12, vy: (Math.random()-0.5)*12, x: 0, y: 0, life: 1.0
                }));
            }
            update() { this.life -= 0.012; this.parts.forEach(p => { p.x += p.vx; p.y += p.vy; p.vy += 0.15; p.life -= 0.025; }); }
            draw() {
                this.parts.forEach(p => {
                    if (p.life > 0) {
                        bgCtx.fillStyle = this.color.replace('hsl', 'hsla').replace(')', `, ${p.life*this.life})`);
                        bgCtx.beginPath(); bgCtx.arc(this.x + p.x, this.y + p.y, 3, 0, Math.PI*2); bgCtx.fill();
                    }
                });
            }
        }

        // --- Game Logic ---
        const gCanvas = document.getElementById('game-canvas');
        const gCtx = gCanvas.getContext('2d');
        let gameActive = false, gameFrame = 0, score = 0, bestScore = 0, isPressing = false;
        const targetScore = 2400;
        const player = { x: 80, y: 0, w: 32, h: 32, dy: 0, gravity: 0.6, thrust: -0.8, jumpPower: -9.5, grounded: false, rotation: 0, mode: 'cube' };
        let obstacles = [], currentMap = null;

        const maps = [
            { name: "Map 1: í‰ì˜¨í•œ ì‹œì‘", accent: "#6366f1", shipStart: 0.5, spawnRate: 80, difficulty: 1.0 },
            { name: "Map 2: ê³ ê³µ ë¹„í–‰", accent: "#10b981", shipStart: 0.3, spawnRate: 70, difficulty: 1.2 },
            { name: "Map 3: ì‹œë ¨ì˜ ì •ì ", accent: "#f43f5e", shipStart: 0.4, spawnRate: 60, difficulty: 1.5 }
        ];

        function initGame() {
            initAudio();
            gCanvas.width = 700; gCanvas.height = 300;
            currentMap = maps[Math.floor(Math.random() * maps.length)];
            document.getElementById('map-name-display').innerText = currentMap.name;
            document.getElementById('game-container').style.borderColor = currentMap.accent;
            player.y = 200; player.dy = 0; player.mode = 'cube';
            obstacles = []; score = 0; gameFrame = 0; gameActive = true;
            updateModeBadge('CUBE', currentMap.accent);
            toggleBGM(true);
            gameLoop();
        }

        function updateModeBadge(text, color) {
            const b = document.getElementById('mode-badge');
            b.innerText = text; b.style.color = color; b.style.borderColor = color; b.style.background = color + "22";
        }

        function handleAction() {
            if (!gameActive) return;
            if (player.mode === 'cube' && player.grounded) {
                player.dy = player.jumpPower; player.grounded = false;
                playJumpSound();
            } else if (player.mode === 'ship') {
                playJumpSound();
            }
        }

        function spawnObs() {
            if (gameFrame % currentMap.spawnRate === 0) {
                const types = player.mode === 'cube' ? ['spike', 'block', 'tallSpike'] : ['spike', 'ceilingSpike', 'plane'];
                const type = types[Math.floor(Math.random() * types.length)];
                let obs = { x: gCanvas.width + 50, type, w: 30, h: 30, speed: (5.5 + score/500) * currentMap.difficulty };
                if (type === 'ceilingSpike') { obs.y = 0; obs.h = 40; }
                else if (type === 'plane') { obs.y = 50 + Math.random()*150; obs.baseY = obs.y; obs.vy = (Math.random()-0.5)*4; obs.w = 40; obs.h = 25; }
                else if (type === 'tallSpike') { obs.h = 55; obs.y = gCanvas.height-40-obs.h; }
                else { obs.y = gCanvas.height-40-obs.h; }
                obstacles.push(obs);
            }
        }

        function gameLoop() {
            if (!gameActive || currentPage !== 3) return;
            gCtx.clearRect(0,0, gCanvas.width, gCanvas.height);
            gameFrame++; score++;

            gCtx.strokeStyle = 'rgba(255,255,255,0.2)'; gCtx.lineWidth = 2;
            gCtx.beginPath(); gCtx.moveTo(0, gCanvas.height-40); gCtx.lineTo(gCanvas.width, gCanvas.height-40); gCtx.stroke();
            if (player.mode === 'ship') { gCtx.beginPath(); gCtx.moveTo(0, 40); gCtx.lineTo(gCanvas.width, 40); gCtx.stroke(); }

            if (score > targetScore * currentMap.shipStart && player.mode === 'cube') {
                player.mode = 'ship'; updateModeBadge('SHIP', '#ff00ff');
            }

            if (player.mode === 'ship') {
                if (isPressing) { player.dy += player.thrust; }
                else player.dy += player.gravity * 0.7;
                player.dy *= 0.96; player.y += player.dy; player.rotation = player.dy * 2.5;
                if (player.y < 40) { player.y = 40; player.dy = 0; }
                if (player.y + player.h > gCanvas.height-40) { player.y = gCanvas.height-40-player.h; player.dy = 0; }
            } else {
                player.dy += player.gravity; player.y += player.dy;
                if (player.y + player.h > gCanvas.height-40) {
                    player.y = gCanvas.height-40-player.h; player.dy = 0; player.grounded = true;
                    player.rotation = Math.round(player.rotation/90)*90;
                } else { player.rotation += 6; player.grounded = false; }
            }

            gCtx.save(); gCtx.translate(player.x+player.w/2, player.y+player.h/2); gCtx.rotate(player.rotation*Math.PI/180);
            if (player.mode === 'ship') {
                gCtx.fillStyle = '#ff00ff'; gCtx.beginPath(); gCtx.moveTo(18,0); gCtx.lineTo(-12,-12); gCtx.lineTo(-8,0); gCtx.lineTo(-12,12); gCtx.closePath(); gCtx.fill(); gCtx.strokeStyle = '#fff'; gCtx.stroke();
            } else {
                gCtx.fillStyle = '#00f2ff'; gCtx.fillRect(-player.w/2, -player.h/2, player.w, player.h); gCtx.strokeStyle = '#fff'; gCtx.strokeRect(-player.w/2, -player.h/2, player.w, player.h);
            }
            gCtx.restore();

            spawnObs();
            obstacles.forEach((obs, i) => {
                obs.x -= obs.speed;
                if (obs.type === 'plane') obs.y = obs.baseY + Math.sin(gameFrame * 0.05) * 40;
                gCtx.fillStyle = (obs.type === 'plane' || obs.type === 'ceilingSpike') ? '#fbbf24' : '#f43f5e';
                if (obs.type === 'spike' || obs.type === 'tallSpike') {
                    gCtx.beginPath(); gCtx.moveTo(obs.x, obs.y + obs.h); gCtx.lineTo(obs.x + obs.w/2, obs.y); gCtx.lineTo(obs.x + obs.w, obs.y + obs.h); gCtx.fill();
                } else if (obs.type === 'ceilingSpike') {
                    gCtx.beginPath(); gCtx.moveTo(obs.x, 0); gCtx.lineTo(obs.x+obs.w/2, obs.h); gCtx.lineTo(obs.x+obs.w, 0); gCtx.fill();
                } else {
                    gCtx.fillRect(obs.x, obs.y, obs.w, obs.h); gCtx.strokeStyle = '#fff'; gCtx.strokeRect(obs.x, obs.y, obs.w, obs.h);
                }

                if (player.x < obs.x+obs.w && player.x+player.w > obs.x && player.y < obs.y+obs.h && player.y+player.h > obs.y) {
                    gameActive = false; bestScore = Math.max(bestScore, score);
                    playCrashSound();
                    document.getElementById('game-status').innerText = "ì¶©ëŒ! ì¬ë„ì „...";
                    document.getElementById('game-best').innerText = `ìµœê³  ê¸°ë¡: ${Math.floor((bestScore/targetScore)*100)}%`;
                    setTimeout(initGame, 1000);
                }
                if (obs.x < -100) obstacles.splice(i, 1);
            });

            const progress = Math.min(100, Math.floor((score/targetScore)*100));
            document.getElementById('game-status').innerText = `ì§„í–‰ë„: ${progress}%`;
            if (score >= targetScore) { gameActive = false; playWinSound(); nextPage(4); }
            else requestAnimationFrame(gameLoop);
        }

        function skipGame() { gameActive = false; playWinSound(); nextPage(4); }

        // --- UI & Navigation ---
        let currentPage = 1;
        const pageTitles = ["Main Page", "Review", "Mini Game", "Closing"];

        function nextPage(p) {
            initAudio();
            const currentEl = document.getElementById(`page-${currentPage}`);
            const nextEl = document.getElementById(`page-${p}`);
            currentEl.classList.remove('active');
            setTimeout(() => {
                currentPage = p; nextEl.classList.add('active');
                document.getElementById('gauge-bar').style.width = (p/4 * 100) + '%';
                document.getElementById('current-page-title').innerText = pageTitles[p-1];
                if (p === 3) initGame();
                if (p === 4) {
                    setInterval(() => { if (currentPage === 4) fireworks.push(new FireworkPart(Math.random()*bgCanvas.width, Math.random()*bgCanvas.height/2.5)); }, 500);
                }
            }, 600);
        }

        function showGuestModal() { document.getElementById('guest-modal').style.display = 'flex'; }
        function hideGuestModal() { document.getElementById('guest-modal').style.display = 'none'; }
        let firstMessage = true;
        function addGuestbook() {
            const input = document.getElementById('guest-input');
            const list = document.getElementById('guestbook-list');
            if (input.value.trim() === "") return;
            if (firstMessage) { list.innerHTML = ""; firstMessage = false; }
            const div = document.createElement('div'); div.className = 'guest-item'; div.innerText = input.value;
            list.prepend(div); input.value = ""; hideGuestModal();
        }

        window.addEventListener('keydown', (e) => { 
            if (currentPage === 3 && (e.code === 'Space' || e.code === 'ArrowUp')) { e.preventDefault(); isPressing = true; handleAction(); }
        });
        window.addEventListener('keyup', (e) => { if (e.code === 'Space' || e.code === 'ArrowUp') isPressing = false; });
        gCanvas.addEventListener('mousedown', () => { isPressing = true; handleAction(); });
        gCanvas.addEventListener('mouseup', () => { isPressing = false; });
        gCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); isPressing = true; handleAction(); });
        gCanvas.addEventListener('touchend', () => isPressing = false);

        window.onload = () => { initBG(); drawBG(); };
    </script>
</body>
</html>
